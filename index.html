<!DOCTYPE html>
<html>
    <head>
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>Patrones de distribución óptima de dispositivos en plantaciones</title>
        <link rel="stylesheet" type="text/css" href="styles.css">
    </head>
    <body>
        <header>
            <h1>Patrones de distribución óptima de dispositivos en plantaciones</h1>
            <p>Más información en <a href="https://github.com/acarril/device-patterns" target="_blank">https://github.com/acarril/device-patterns</a></p>
        </header>

        <main>
            <form id="api-form">
                <div class="form-row">
                    <div class="form-group">
                        <label for="p">Plantas:</label>
                        <p class="description">Número de plantas por hectárea</p>
                        <input type="number" id="p" name="p" placeholder="Número de plantas" required>
                    </div>
                    <div class="form-group">
                        <label for="n_max">Max. hileras:</label>
                        <p class="description">Máximo de hileras permitidas en la optimización</p>
                        <input type="number" id="n_max" name="n_max" placeholder="Número máximo de hileras" value=6 required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="d_min">Dosis mínima:</label>
                        <p class="description">Número mínimo de dispositivos a instalar</p>
                        <input type="number" id="d_min" name="d_min" placeholder="Dosis mínima" required>
                    </div>
                    <div class="form-group">
                        <label for="tolerance_factor">Factor max. dosis:</label>
                        <p class="description">Factor de expansión para máxima dosis permitida en la optimización</p>
                        <input type="number" id="tolerance_factor" name="tolerance_factor" placeholder="Factor máximo de dosis" value=1.05 min=1 step="any" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="sag_compliant">Restricciones SAG:</label>
                        <p class="description">Restringe rango de ratios (i.e. patrones) permitidos</p>
                        <input type="checkbox" id="sag_compliant" name="sag_compliant" value="1">
                    </div>
                </div>                
                <input type="submit" value="Calcular">
            </form>
            <div id="loader" class="loader">
                <span class="loading-dot" style="animation: loading 1.2s 0.0s infinite;">●</span>
                <span class="loading-dot" style="animation: loading 1.2s 0.2s infinite;">●</span>
                <span class="loading-dot" style="animation: loading 1.2s 0.4s infinite;">●</span>
                <span class="loading-dot" style="animation: loading 1.2s 0.6s infinite;">●</span>
                <span class="loading-dot" style="animation: loading 1.2s 0.8s infinite;">●</span>
            </div>  <!-- Loader -->
            <section id="result">
                <!-- Results will be populated here -->
            </section>
        </main>

        <script>
            document.getElementById('api-form').addEventListener('submit', function(event) {
                event.preventDefault(); // prevent the form from being submitted normally

                // Clear previous results and show the loader
                const resultDiv = document.getElementById('result');
                resultDiv.innerHTML = '';
                document.getElementById('loader').style.display = 'inline-block';

                const p = document.getElementById('p').value;
                const d_min = document.getElementById('d_min').value;
                const n_max = document.getElementById('n_max').value;
                const tolerance_factor = document.getElementById('tolerance_factor').value;
                const sag_compliant = document.getElementById('sag_compliant').checked ? 1 : 0;
        
                fetch('https://jix6oc21j7.execute-api.us-east-1.amazonaws.com/api/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        p: p,
                        d_min: d_min,
                        n_max: n_max,
                        tolerance_factor: tolerance_factor,
                        sag_compliant: sag_compliant
                    })
                })
                .then(response => response.json())
                .then(data => {
                    // Hide the loader
                    document.getElementById('loader').style.display = 'none';

                    resultDiv.innerHTML = '<h2>Resultados</h2>';

                    ['min_densidad', 'min_hileras'].forEach(key => {
                        const item = data[key];
                        let title = '';
                        if (key === 'min_densidad') {
                            title = 'Min. dosis';
                        } else if (key === 'min_hileras') {
                            title = 'Min. hileras';
                        }
                        resultDiv.innerHTML += `
                            <h3>${title}:</h3>
                            <p>Dosis: ${item.densidad}</p>
                        `;
                        item.patrones.forEach(pattern => {
                            let [filled, total] = pattern.split('/').map(Number);
                            if(isNaN(total)) {
                                total = 1;
                            }
                            let dotString = '';
                            for (let i = 0; i < 20; i++) {
                                const shouldFill = i % total < filled;
                                if (shouldFill) {
                                    dotString += '<span class="dot filled"></span>';
                                } else {
                                    dotString += '<span class="dot"></span>';
                                }
                            }
                            resultDiv.innerHTML += `
                                <div class="pattern-container">
                                    <p>${pattern}:</p>
                                    <div class="pattern">${dotString}<span class="dots">...</span></div>
                                </div>
                            `;
                        });
                    });
                });
            });
        </script>
    </body>
</html>
